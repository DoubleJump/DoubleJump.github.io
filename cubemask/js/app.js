"use strict";function clear_stacks(){for(var a=_stacks.length,b=0;b<a;++b)_stacks[b].index=0}function BinaryReader(a){var b={};return b.buffer=a,b.bytes=new DataView(a),b.offset=0,b}function Request(a,b){var c=new XMLHttpRequest;return c.open("GET",b,!0),c.responseType=a,c}function set_reader_ctx(a){_BR=a}function end_reader_ctx(){_BR=null}function read_boolean(){var a=read_i32();return 1===a}function read_bytes(a){var b=new Uint8Array(_BR.buffer,_BR.offset,a);return _BR.offset+=a,b}function read_i32(a){var b;return a?(b=new Int32Array(_BR.buffer,_BR.offset,a),_BR.offset+=4*a,b):(b=_BR.bytes.getInt32(_BR.offset,!0),_BR.offset+=4,b)}function read_u32(a){var b;return a?(b=new Uint32Array(_BR.buffer,_BR.offset,a),_BR.offset+=4*a,b):(b=_BR.bytes.getUint32(_BR.offset,!0),_BR.offset+=4,b)}function read_f32(a){var b;return a?(b=new Float32Array(_BR.buffer,_BR.offset,a),_BR.offset+=4*a,b):(b=_BR.bytes.getFloat32(_BR.offset,!0),_BR.offset+=4,b)}function read_f64(a){var b;return a?(b=new Float64Array(_BR.buffer,_BR.offset,a),_BR.offset+=8*a,b):(b=_BR.bytes.getFloat64(_BR.offset,!0),_BR.offset+=8,b)}function read_string(){var a=read_i32(),b=read_i32(),c=String.fromCharCode.apply(null,new Uint8Array(_BR.buffer,_BR.offset,b));return _BR.offset+=b+a,c}function uint8_to_base64(a){for(var d,e,f,g,h,i,j,b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",c="",k=0,l=a.length;k<l;)d=a[k++],e=k<a.length?a[k++]:Number.NaN,f=k<a.length?a[k++]:Number.NaN,g=d>>2,h=(3&d)<<4|e>>4,i=(15&e)<<2|f>>6,j=63&f,isNaN(e)?i=j=64:isNaN(f)&&(j=64),c+=b.charAt(g)+b.charAt(h)+b.charAt(i)+b.charAt(j);return c}function AssetGroup(){var a={};return a.shaders={},a.meshes={},a.textures={},a.fonts={},a.animations={},a.rigs={},a.curves={},a}function bind_assets(a){for(var b in a.shaders)bind_shader(a.shaders[b]);for(var b in a.meshes){var c=a.meshes[b];bind_mesh(c),update_mesh(c)}for(var b in a.textures){var d=a.textures[b];bind_texture(d),update_texture(d)}for(var b in a.fonts){var e=a.fonts[b];bind_texture(e.atlas),update_texture(e.atlas)}}function read_asset_file(a){var b=BinaryReader(a,!0),c=AssetGroup();set_reader_ctx(b);for(var d=!1;d===!1;){var e=read_i32();switch(e){case AssetType.SHADER:read_shader(c);break;case AssetType.SCENE:read_scene(c);break;case AssetType.FONT:read_font(c);break;case AssetType.PNG:read_texture("png",c);break;case AssetType.JPG:read_texture("jpg",c);break;case AssetType.END:d=!0;break;default:d=!0}}return end_reader_ctx(),c}function read_scene(a){for(var c=(read_string(),!1);c===!1;){var d=read_i32();switch(d){case AssetType.CAMERA:read_camera(a);break;case AssetType.LAMP:read_lamp(a);break;case AssetType.MESH:read_mesh(a);break;case AssetType.MATERIAL:read_material(a);break;case AssetType.ACTION:read_animation(a);break;case AssetType.EMPTY:read_transform(a);break;case AssetType.ENTITY:read_entity(a);break;case AssetType.RIG:read_rig(a);break;case AssetType.RIG_ACTION:read_rig_action(a);break;case AssetType.CURVE:read_curve(a);break;case AssetType.END:c=!0;break;default:c=!0}}}function radians(a){return a*DEG2RAD}function degrees(a){return a*RAD2DEG}function min(a,b){return a<b?a:b}function max(a,b){return a>b?a:b}function round_to(a,b){return a.toFixed(b)}function clamp(a,b,c){return a<b?b:a>c?c:a}function lerp(a,b,c){return(1-c)*a+c*b}function distance(a,b,c,d){var e=c-a,f=d-b;return Math.sqrt(e*e+f*f)}function angle(a,b){return Math.atan2(b,a)*RAD2DEG+180}function snap_angle(a,b){return Math.floor((a%360+b/2)/b)*b}function sigmoid(a){var b=1/(1+Math.exp(-a));return 2*(b-.5)}function smoothstep(a,b,c){var d=Math.max(0,Math.min(1,(c-a)/(b-a)));return d*d*(3-2*d)}function compare_normal(a,b,c){var d=vec3_stack.index,e=_Vec3();quat_mul_vec(e,c,a);var f=vec_dot(e,b)*RAD2DEG;return vec3_stack.index=d,f}function move_towards(a,b,c){var d=a;if(b>a){if(d+=c,d>b)return b}else if(d-=c,d<b)return b;return d}function smooth_float_towards(a,b,c,d){var e=d||1e-4,f=a,g=b-a;return g=clamp(g,-c,c),Math.abs(g)<e?b:f+=g*c}function lazy_ease(a,b,c){return a+(b-a)/c}function smooth_vec_towards(a,b,c,d){for(var e=a.length,f=0;f<e;++f)a[f]=smooth_float_towards(a[f],b[f],c,d)}function wrap_value(a,b,c){return a>c?a-c:a<b?a+c:a}function wrap_angle(a){return wrap_value(a,0,360)}function wrap_normal(a){return wrap_value(a,0,1)}function rand_int(a,b){return Math.floor(Math.random()*(b-a+1))+a}function rand_sign(){var a=rand_int(0,1);return 0===a?-1:1}function rand_float(a,b){return Math.random()*(b-a)+a}function rand_float_fuzzy(a,b){return rand_float(a-b,a+b)}function rand_vec(a,b,c){for(var d=a.length,e=0;e<d;++e)a[e]=Math.random()*(c-b)+b}function rand_circle(a,b,c){var d=rand_float(b||1,c||1),e=rand_float(-1,1),f=rand_float(-1,1),g=1/Math.sqrt(e*e+f*f);a[0]=e*g*d,a[1]=f*g*d}function Time(){var a={};return a.start=0,a.elapsed=0,a.now=0,a.last=0,a.dt=0,a.at=0,a.st=0,a.nst=0,a.frame=0,a.scale=1,a.paused=!1,a}function set_time(a,b){a.frame++,a.now=b,a.dt=(b-a.last)/1e3*a.scale,a.dt>.05&&(a.dt=.016),a.last=b,a.elapsed+=a.dt*a.scale,a.at+=a.dt,a.at>1&&(a.at-=1),a.st=Math.sin(3*a.elapsed),a.nst=a.st/2+.5}function Vec3(a,b,c){return new Float32Array([a||0,b||0,c||0])}function Vec4(a,b,c,d){return new Float32Array([a||0,b||0,c||0,d||1])}function set_vec3(a,b,c,d){a[0]=b,a[1]=c,a[2]=d||0}function set_vec4(a,b,c,d,e){a[0]=b,a[1]=c,a[2]=d,a[3]=e}function _Vec3(a,b,c){var d=vec3_stack.get();return set_vec3(d,a||0,b||0,c||0),d}function _Vec4(a,b,c,d){var e=vec4_stack.get();return set_vec4(e,a||0,b||0,c||0,d||1),e}function vec_approx_equal(a,b){for(var c=a.length,d=0;d<c;++d)if(Math.abs(a[d]-b[d])>EPSILON)return!1;return!0}function vec_add(a,b,c){for(var d=a.length,e=0;e<d;++e)a[e]=b[e]+c[e]}function vec_add_f(a,b,c){for(var d=a.length,e=0;e<d;++e)a[e]=b[e]+c}function vec_sub(a,b,c){for(var d=a.length,e=0;e<d;++e)a[e]=b[e]-c[e]}function vec_sub_f(a,b,c){for(var d=a.length,e=0;e<d;++e)a[e]=b[e]-c}function vec_mul_f(a,b,c){for(var d=a.length,e=0;e<d;++e)a[e]=b[e]*c}function vec_div_f(a,b,c){for(var d=a.length,e=0;e<d;++e)a[e]=b[e]/c}function vec_eq(a,b){for(var c=a.length,d=0;d<c;++d)a[d]=b[d]}function vec_inverse(a,b){for(var c=a.length,d=0;d<c;++d)a[d]=-b[d]}function vec_sqr_length(a){for(var b=0,c=a.length,d=0;d<c;++d)b+=a[d]*a[d];return b}function vec_length(a){return Math.sqrt(vec_sqr_length(a))}function vec_distance(a,b){return Math.sqrt(vec_sqr_distance(a,b))}function vec_sqr_distance(a,b){for(var c=0,d=a.length,e=0;e<d;++e){var f=b[e]-a[e];c+=f*f}return c}function vec_normalized(a,b){var c=b.length,d=vec_sqr_length(b);if(d>EPSILON){d=Math.sqrt(1/d);for(var e=0;e<c;++e)a[e]=b[e]*d}else vec_eq(a,b)}function vec_dot(a,b){for(var c=0,d=a.length,e=0;e<d;++e)c+=a[e]*b[e];return c}function vec_perp(a,b){var c=-b[1],d=b[0];a[0]=c,a[1]=d,vec_normalized(a,a)}function vec_angle2D(a){return Math.atan2(a[1],a[0])}function vec_min(a,b,c){for(var d=v.length,e=0;e<d;++e)a[e]=Math.min(b[e],c[e])}function vec_max(a,b,c){for(var d=v.length,e=0;e<d;++e)a[e]=Math.max(b[e],c[e])}function vec_lerp(a,b,c,d){for(var e=1-d,f=v.length,g=0;g<f;++g)a[g]=e*b[g]+d*c[g]}function vec_clamp(a,b,c){for(var d=a.length,e=0;e<d;++e)a[e]<b[e]&&(a[e]=b[e]),a[e]>c[e]&&(a[e]=c[e])}function vec_clamp_f(a,b,c){for(var d=a.length,e=0;e<d;++e)a[e]<b&&(a[e]=b),a[e]>c&&(a[e]=c)}function vec_reflect(a,b,c){vec_add(a,v,c),vec_mulf(a,-2*vec_dot(v,c))}function vec_cross(a,b,c){var d=b[1]*c[2]-b[2]*c[1],e=b[2]*c[0]-b[0]*c[2],f=b[0]*c[1]-b[1]*c[0];set_vec3(a,d,e,f)}function vec_project(a,b,c){vec_mul_f(a,b,vec_dot(b,c));var d=vec_sqr_length(a);d<1&&vec_div_f(a,Math.sqrt(d))}function vec_tangent(a,b,c,d){var e=_Vec3();vec_add(e,c,b),vec_normalized(e,e),vec_cross(a,e,d)}function vec_rotate(a,b,c){var d=2*(c[1]*b[2]-c[2]*b[1]),e=2*(c[2]*b[0]-c[0]*b[2]),f=2*(c[0]*b[1]-c[1]*b[0]),g=c[1]*f-c[2]*e,h=c[2]*d-c[0]*f,i=c[0]*e-c[1]*d;a[0]=b[0]+c[2]*d+g,a[1]=b[1]+c[2]*e+h,a[2]=b[2]+c[2]*f+i}function vec_lerp(a,b,c,d){for(var e=a.length,f=1-d,g=0;g<e;++g)a[g]=f*b[g]+d*c[g]}function vec_to_string(a,b){for(var c="[",d=a.length,e=0;e<d-1;++e)c+=Math.round_to(a[e],b)+", ";return c+=Math.round_to(a[d-1],b),c+="]"}function quat_mul(a,b,c){var d=b[3]*c[0]+b[0]*c[3]+b[1]*c[2]-b[2]*c[1],e=b[3]*c[1]+b[1]*c[3]+b[2]*c[0]-b[0]*c[2],f=b[3]*c[2]+b[2]*c[3]+b[0]*c[1]-b[1]*c[0],g=b[3]*c[3]-b[0]*c[0]-b[1]*c[1]-b[2]*c[2];set_vec4(a,d,e,f,g)}function quat_mul_vec(a,b,c){var d=2*(b[1]*c[2]-b[2]*c[1]),e=2*(b[2]*c[0]-b[0]*c[2]),f=2*(b[0]*c[1]-b[1]*c[0]),g=b[1]*f-b[2]*e,h=b[2]*d-b[0]*f,i=b[0]*e-b[1]*d;a[0]=c[0]+b[3]*d+g,a[1]=c[1]+b[3]*e+h,a[2]=c[2]+b[3]*f+i}function quat_conjugate(a,b){set_vec4(a,-b[0],-b[1],-b[2],b[3])}function quat_inverse(a,b){var c=_Vec4();quat_conjugate(c,b),vec_normalized(a,c)}function quat_set_euler(a,b){quat_set_euler_f(a,b[0],b[1],b[2])}function quat_set_euler_f(a,b,c,d){var e=b*DEG2RAD/2,f=c*DEG2RAD/2,g=d*DEG2RAD/2,h=Math.sin(e),i=Math.sin(f),j=Math.sin(g),k=Math.cos(e),l=Math.cos(f),m=Math.cos(g);a[0]=h*l*m-k*i*j,a[1]=k*i*m+h*l*j,a[2]=k*l*j-h*i*m,a[3]=k*l*m+h*i*j}function quat_get_euler(a,b){var c,d,e,f=b[0]*b[0],g=b[1]*b[1],h=b[2]*b[2],i=b[3]*b[3],j=f+g+h+i,k=b[0]*b[1]+b[2]*b[3],l=.499;k>l*j?(c=0,d=2*Math.atan2(b[0],b[3]),e=PI/2):k<-l*j?(c=0,d=-2*Math.atan2(b[0],b[3]),e=-PI/2):(c=Math.atan2(2*b[0]*b[3]-2*b[1]*b[2],-f+g-h+i),d=Math.atan2(2*b[1]*b[3]-2*b[0]*b[2],f-g-h+i),e=Math.asin(2*k/j)),c*=RAD2DEG,d*=RAD2DEG,e*=RAD2DEG,set_vec3(a,c,d,e)}function quat_set_angle_axis(a,b,c){var d=b*DEG2RAD,e=.5*d,f=Math.sin(e);a[0]=f*c[0],a[1]=f*c[1],a[2]=f*c[2],a[3]=Math.cos(e)}function quat_get_angle_axis(a,b){var c=vec_sqr_length(a);if(c>EPSILON){var d=1/Math.sqrt(c);return b[0]=a[0]*d,b[1]=a[1]*d,b[2]=a[2]*d,2*Math.acos(a[3])*RAD2DEG}return set_vec3(b,1,0,0),0}function quat_from_to(a,b,c){var d=vec3_stack.index,e=_Vec3(),f=_Vec3(),g=_Vec3();vec_normalized(e,b),vec_normalized(f,c),vec_cross(g,e,f);var h=_Vec4();h[0]=g[0],h[1]=g[1],h[2]=g[2],h[3]=1+vec_dot(e,f),vec_normalized(a,h),vec3_stack.index=d}function quat_look_at(a,b,c,d){_Vec3();vec_sub(temp,b,c),vec_normalized(temp,temp),quat_from_to(a,d,c)}function quat_slerp(a,b,c,d){var e=1,f=b[3]*c[3]+b[0]*c[0]+b[1]*c[1]+b[2]*c[2];if(f<0&&(f=-f,e=-1),1-f<EPSILON)return a[0]=(1-d)*b[0]+d*e*c[0],a[1]=(1-d)*b[1]+d*e*c[1],a[2]=(1-d)*b[2]+d*e*c[2],void(a[3]=(1-d)*b[3]+d*e*c[3]);var g=Math.acos(f),h=Math.sin(g),i=Math.sin((1-d)*g)/h,j=Math.sin(d*g)/h*e;a[0]=b[0]*i+c[0]*j,a[1]=b[1]*i+c[1]*j,a[2]=b[2]*i+c[2]*j,a[3]=b[3]*i+c[3]*j,vec_normalized(a,a)}function Mat3(){return new Float32Array([1,0,0,0,1,0,0,0,1])}function _Mat3(){var a=mat3_stack.get();return mat3_identity(a),a}function mat3_from_mat4(a,b){a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[4],a[4]=b[5],a[5]=b[6],a[6]=b[8],a[7]=b[9],a[8]=b[10]}function mat3_identity(a){a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=1,a[5]=0,a[6]=0,a[7]=0,a[8]=1}function mat3_determinant(a){return a[0]*(a[4]*a[8]-a[5]*a[7])-a[1]*(a[3]*a[8]-a[5]*a[6])+a[2]*(a[3]*a[7]-a[4]*a[6])}function mat3_inverse(a,b){var c=_Mat3();c[0]=b[4]*b[8]-b[5]*b[7],c[1]=b[2]*b[7]-b[1]*b[8],c[2]=b[1]*b[5]-b[2]*b[4],c[3]=b[5]*b[6]-b[3]*b[8],c[4]=b[0]*b[8]-b[2]*b[6],c[5]=b[2]*b[3]-b[0]*b[5],c[6]=b[3]*b[7]-b[4]*b[6],c[7]=b[1]*b[6]-b[0]*b[7],c[8]=b[0]*b[4]-b[1]*b[3];var d=b[0]*c[0]+b[1]*c[3]+b[2]*c[6];Math.abs(d)<=EPSILON&&mat3_identity(a);for(var e=1/d,f=0;f<9;++f)a[f]=c[f]*e;mat3_stack.index--}function mat3_mul(a,b,c){var d=_Mat3();d[0]=b[0]*c[0]+b[1]*c[3]+b[2]*c[6],d[1]=b[0]*c[1]+b[1]*c[4]+b[2]*c[7],d[2]=b[0]*c[2]+b[1]*c[5]+b[2]*c[8],d[3]=b[3]*c[0]+b[4]*c[3]+b[5]*c[6],d[4]=b[3]*c[1]+b[4]*c[4]+b[5]*c[7],d[5]=b[3]*c[2]+b[4]*c[5]+b[5]*c[8],d[6]=b[6]*c[0]+b[7]*c[3]+b[8]*c[6],d[7]=b[6]*c[1]+b[7]*c[4]+b[8]*c[7],d[8]=b[6]*c[2]+b[7]*c[5]+b[8]*c[8],vec_eq(a,d)}function mat3_transposed(a,b){var c=_Mat3();c[1]=b[3],c[2]=b[6],c[3]=b[1],c[5]=b[7],c[6]=b[2],c[7]=b[5],c[8]=b[0],vec_eq(a,c)}function mat3_set_position(a,b,c){a[2]=b,a[5]=c}function mat3_set_rotation(a,b){var c=2*b[0],d=2*b[1],e=2*b[2],f=b[0]*c,g=b[0]*d,h=b[0]*e,i=b[1]*d,j=b[1]*e,k=b[2]*e,l=b[3]*c,m=b[3]*d,n=b[3]*e;a[0]=1-(i+k),a[1]=g+n,a[2]=h-m,a[3]=g-n,a[4]=1-(f+k),a[5]=j+l,a[6]=h+m,a[7]=j-l,a[8]=1-(f+i)}function mat3_compose_f(a,b,c,d,e,f){var g=.01745329251*-f,h=Math.sin(g),i=Math.cos(g);a[0]=i*d,a[1]=h*e,a[2]=b,a[3]=-h*d,a[4]=i*e,a[5]=c,a[6]=0,a[7]=0,a[8]=1}function mat3_compose(a,b,c,d){mat3_compose_f(a,b[0],b[1],c[0],c[1],d)}function Mat4(){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}function _Mat4(){var a=mat4_stack.get();return mat4_identity(a),a}function mat4_identity(a){a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1}function mat4_mul(a,b,c){var d=_Mat4();d[0]=b[0]*c[0]+b[1]*c[4]+b[2]*c[8]+b[3]*c[12],d[1]=b[0]*c[1]+b[1]*c[5]+b[2]*c[9]+b[3]*c[13],d[2]=b[0]*c[2]+b[1]*c[6]+b[2]*c[10]+b[3]*c[14],d[3]=b[0]*c[3]+b[1]*c[7]+b[2]*c[11]+b[3]*c[15],d[4]=b[4]*c[0]+b[5]*c[4]+b[6]*c[8]+b[7]*c[12],d[5]=b[4]*c[1]+b[5]*c[5]+b[6]*c[9]+b[7]*c[13],d[6]=b[4]*c[2]+b[5]*c[6]+b[6]*c[10]+b[7]*c[14],d[7]=b[4]*c[3]+b[5]*c[7]+b[6]*c[11]+b[7]*c[15],d[8]=b[8]*c[0]+b[9]*c[4]+b[10]*c[8]+b[11]*c[12],d[9]=b[8]*c[1]+b[9]*c[5]+b[10]*c[9]+b[11]*c[13],d[10]=b[8]*c[2]+b[9]*c[6]+b[10]*c[10]+b[11]*c[14],d[11]=b[8]*c[3]+b[9]*c[7]+b[10]*c[11]+b[11]*c[15],d[12]=b[12]*c[0]+b[13]*c[4]+b[14]*c[8]+b[15]*c[12],d[13]=b[12]*c[1]+b[13]*c[5]+b[14]*c[9]+b[15]*c[13],d[14]=b[12]*c[2]+b[13]*c[6]+b[14]*c[10]+b[15]*c[14],d[15]=b[12]*c[3]+b[13]*c[7]+b[14]*c[11]+b[15]*c[15],vec_eq(a,d),mat4_stack.index--}function mat4_determinant(a){var b=a[0]*a[5]-a[1]*a[4],c=a[0]*a[6]-a[2]*a[4],d=a[0]*a[7]-a[3]*a[4],e=a[1]*a[6]-a[2]*a[5],f=a[1]*a[7]-a[3]*a[5],g=a[2]*a[7]-a[3]*a[6],h=a[8]*a[13]-a[9]*a[12],i=a[8]*a[14]-a[10]*a[12],j=a[8]*a[15]-a[11]*a[12],k=a[9]*a[14]-a[10]*a[13],l=a[9]*a[15]-a[11]*a[13],m=a[10]*a[15]-a[11]*a[14];return b*m-c*l+d*k+e*j-f*i+g*h}function mat4_transposed(a,b){var c=_Mat4();c[1]=b[4],c[2]=b[8],c[3]=b[12],c[4]=b[1],c[6]=b[9],c[7]=b[13],c[8]=b[2],c[9]=b[6],c[11]=b[14],c[12]=b[3],c[13]=b[7],c[14]=b[11],c[15]=b[15],vec_eq(a,c),mat4_stack.index--}function mat4_inverse(a,b){var c=b[2]*b[7]-b[6]*b[3],d=b[2]*b[11]-b[10]*b[3],e=b[2]*b[15]-b[14]*b[3],f=b[6]*b[11]-b[10]*b[7],g=b[6]*b[15]-b[14]*b[7],h=b[10]*b[15]-b[14]*b[11],i=h*b[5]-g*b[9]+f*b[13],j=-(h*b[1]-e*b[9]+d*b[13]),k=g*b[1]-e*b[5]+c*b[13],l=-(f*b[1]-d*b[5]+c*b[9]),m=1/(i*b[0]+j*b[4]+k*b[8]+l*b[12]);a[0]=i*m,a[1]=j*m,a[2]=k*m,a[3]=l*m,a[4]=-(h*b[4]-g*b[8]+f*b[12])*m,a[5]=(h*b[0]-e*b[8]+d*b[12])*m,a[6]=-(g*b[0]-e*b[4]+c*b[12])*m,a[7]=(f*b[0]-d*b[4]+c*b[8])*m,c=b[1]*b[7]-b[5]*b[3],d=b[1]*b[11]-b[9]*b[3],e=b[1]*b[15]-b[13]*b[3],f=b[5]*b[11]-b[9]*b[7],g=b[5]*b[15]-b[13]*b[7],h=b[9]*b[15]-b[13]*b[11],a[8]=(h*b[4]-g*b[8]+f*b[12])*m,a[9]=-(h*b[0]-e*b[8]+d*b[12])*m,a[10]=(g*b[0]-e*b[4]+c*b[12])*m,a[11]=-(f*b[0]-d*b[4]+c*b[8])*m,c=b[6]*b[1]-b[2]*b[5],d=b[10]*b[1]-b[2]*b[9],e=b[14]*b[1]-b[2]*b[13],f=b[10]*b[5]-b[6]*b[9],g=b[14]*b[5]-b[6]*b[13],h=b[14]*b[9]-b[10]*b[13],a[12]=-(h*b[4]-g*b[8]+f*b[12])*m,a[13]=(h*b[0]-e*b[8]+d*b[12])*m,a[14]=-(g*b[0]-e*b[4]+c*b[12])*m,a[15]=(f*b[0]-d*b[4]+c*b[8])*m}function mat4_inverse_affine(a,b){var c=b[10]*b[5]-b[6]*b[9],d=b[2]*b[9]-b[10]*b[1],e=b[6]*b[1]-b[2]*b[5],f=1/(b[0]*c+b[4]*d+b[8]*e),g=b[0]*f,h=b[4]*f,i=b[8]*f;return a[0]=c*f,a[1]=d*f,a[2]=e*f,a[3]=0,a[4]=i*b[6]-h*b[10],a[5]=g*b[10]-i*b[2],a[6]=h*b[2]-g*b[6],a[7]=0,a[8]=h*b[9]-i*b[5],a[9]=i*b[1]-g*b[9],a[10]=g*b[5]-h*b[1],a[11]=0,a[12]=-(a[0]*b[12]+a[4]*b[13]+a[8]*b[14]),a[13]=-(a[1]*b[12]+a[5]*b[13]+a[9]*b[14]),a[14]=-(a[2]*b[12]+a[6]*b[13]+a[10]*b[14]),a[15]=1,a}function mat4_translate(a,b){var c=_Mat4();vec_eq(c,a),a[12]=c[0]*b[0]+c[4]*b[1]+c[8]*b[2]+c[12],a[13]=c[1]*b[0]+c[5]*b[1]+c[9]*b[2]+c[13],a[14]=c[2]*b[0]+c[6]*b[1]+c[10]*b[2]+c[14],a[15]=c[3]*b[0]+c[7]*b[1]+c[11]*b[2]+c[15],mat4_stack.index--}function mat4_set_position(a,b){a[12]=b[0],a[13]=b[1],a[14]=b[2]}function mat4_get_position(a,b){a[0]=b[12],a[1]=b[13],a[2]=b[14]}function mat4_set_scale(a,b){a[0]=b[0],a[5]=b[1],a[10]=b[2]}function mat4_scale(a,b){a[0]*=b[0],a[1]*=b[0],a[2]*=b[0],a[3]*=b[0],a[4]*=b[1],a[5]*=b[1],a[6]*=b[1],a[7]*=b[1],a[8]*=b[2],a[9]*=b[2],a[10]*=b[2],a[11]*=b[2]}function mat4_get_scale(a,b){a[0]=b[0],a[1]=b[5],a[2]=b[10]}function mat4_rotate_x(a,b){var c=_Mat4();vec_eq(c,a);var d=Math.sin(b),e=Math.cos(b);return a[4]=c[4]*e+c[8]*d,a[5]=c[5]*e+c[9]*d,a[6]=c[6]*e+c[10]*d,a[7]=c[7]*e+c[11]*d,a[8]=c[8]*e-c[4]*d,a[9]=c[9]*e-c[5]*d,a[10]=c[10]*e-c[6]*d,a[11]=c[11]*e-c[7]*d,mat4_stack.index--,a}function mat4_rotate_y(a,b){var c=_Mat4();vec_eq(c,a);var d=Math.sin(b),e=Math.cos(b);return a[0]=c[0]*e-c[8]*d,a[1]=c[1]*e-c[9]*d,a[2]=c[2]*e-c[10]*d,a[3]=c[3]*e-c[11]*d,a[8]=c[0]*d+c[8]*e,a[9]=c[1]*d+c[9]*e,a[10]=c[2]*d+c[10]*e,a[11]=c[3]*d+c[11]*e,mat4_stack.index--,a}function mat4_rotate_z(a,b){var c=_Mat4();vec_eq(c,a);var d=Math.sin(b),e=Math.cos(b);return a[0]=c[0]*e+c[4]*d,a[1]=c[1]*e+c[5]*d,a[2]=c[2]*e+c[6]*d,a[3]=c[3]*e+c[7]*d,a[4]=c[4]*e-c[0]*d,a[5]=c[5]*e-c[1]*d,a[6]=c[6]*e-c[2]*d,a[7]=c[7]*e-c[3]*d,mat4_stack.index--,a}function mat4_set_rotation(a,b){var c=2*b[0],d=2*b[1],e=2*b[2],f=b[0]*c,g=b[0]*d,h=b[0]*e,i=b[1]*d,j=b[1]*e,k=b[2]*e,l=b[3]*c,m=b[3]*d,n=b[3]*e;a[0]=1-(i+k),a[1]=g+n,a[2]=h-m,a[3]=0,a[4]=g-n,a[5]=1-(f+k),a[6]=j+l,a[7]=0,a[8]=h+m,a[9]=j-l,a[10]=1-(f+i),a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1}function mat4_get_rotation(a,b){var c;b[10]<0?b[0]>b[5]?(c=1+b[0]-b[5]-b[10],vec4_set(c,b[1]+b[4],b[8]+b[2],b[6]-b[9])):(c=1-b[0]+b[5]-b[10],vec4_set(b[1]+b[4],c,b[6]+b[9],b[8]-b[2])):b[0]<-b[5]?(c=1-b[0]-b[5]+b[10],vec4_set(b[8]+b[2],b[6]+b[9],c,b[1]-b[4])):(c=1+b[0]+b[5]+b[10],vec4_set(b[6]-b[9],b[8]-b[2],b[1]-b[4],c));var d=_Vec4();vec_mul_f(d,a,.5),vec_div_f(a,d,c)}function mat4_compose(a,b,c,d){mat4_set_rotation(a,d),mat4_scale(a,c),mat4_set_position(a,b)}function mat4_mul_point(a,b,c){var d=b[0]*c[0]+b[4]*c[1]+b[8]*c[2]+b[12],e=b[1]*c[0]+b[5]*c[1]+b[9]*c[2]+b[13],f=b[2]*c[0]+b[6]*c[1]+b[10]*c[2]+b[14];a[0]=d,a[1]=e,a[2]=f}function mat4_mul_dir(a,b,c){var d=b[0]*c[0]+b[4]*c[1]+b[8]*c[2],e=b[1]*c[0]+b[5]*c[1]+b[9]*c[2],f=b[2]*c[0]+b[6]*c[1]+b[10]*c[2];a[0]=d,a[1]=e,a[2]=f}function mat4_mul_projection(a,b,c){var d=1/(b[3]*c[0]+b[7]*c[1]+b[11]*c[2]+b[15]),e=(b[0]*c[0]+b[4]*c[1]+b[8]*c[2]+b[12])*d,f=(b[1]*c[0]+b[5]*c[1]+b[9]*c[2]+b[13])*d,g=(b[2]*c[0]+b[6]*c[1]+b[10]*c[2]+b[14])*d;a[0]=e,a[1]=f,a[2]=g}function Curve(a,b){var c={};return c.data=b,c.dimension=a,c.stride=3*a,c}function eval_time_curve(a,b,c){var d=b.dimension,e=b.data,f=e.length,g=e[d],h=e[f-2*d];c<g?c=g:c>h&&(c=h);for(var i=0;i<f;){var g=e[i+d],h=e[i+4*d];if(c>=g&&c<=h)return c=(c-g)/(h-g),void eval_curve(a,b,c,i+d);i+=b.stride}}function eval_curve(a,b,c,d){for(var e=c*c,f=e*c,g=1-c,h=g*g,i=h*g,j=b.dimension,k=b.data,l=0;l<j;++l){var m=l+d;a[l]=i*k[m]+3*h*c*k[m+1*j]+3*e*g*k[m+2*j]+f*k[m+3*j]}}function eval_curve_f(a,b){var c=_Vec3();return eval_curve(c,a,b,0),vec3_stack.index--,c[1]}function read_curve(){var c,a=read_boolean(br),b=read_i32();return c=read_f32(a===!0?6*b:9*b)}function perspective_projection(a,b,c,d,e){mat4_identity(a);var f=1/Math.tan(e*PI_OVER_360),g=b-c;a[0]=f/d,a[5]=f,a[10]=(c+b)/g,a[11]=-1,a[14]=2*(b*c)/g,a[15]=1}function ortho_projection(a,b,c,d,e){mat4_identity(a),a[0]=2/b,a[5]=2/c,a[10]=-2/(e-d),a[11]=-d/(e-d),a[15]=1}function cartesian_to_polar(a,b){var c=vec_length(b),d=Math.atan2(b[1],b[0]),e=Math.acos(2/c);set_vec3(a,d,e,c)}function polar_to_cartesian(a,b,c,d){var e=b*DEG2RAD,f=c*DEG2RAD,g=d*Math.cos(f)*Math.cos(e),h=d*Math.sin(f),i=d*Math.cos(f)*Math.sin(e);set_vec3(a,g,h,i)}function lng_lat_to_cartesian(a,b,c,d){polar_to_cartesian(a,-b+90,c,d)}function world_to_screen(a,b,c,d){var e=_Vec3();mat4_mul_projection(e,b,c),a[0]=(e[0]+1)/2*d[2],a[1]=(1-e[1])/2*d[3],vec3_stack.index--}function screen_to_view(a,b,c){a[0]=b[0]/c[2],a[1]=1-b[1]/c[3],a[2]=b[2]}function screen_to_world(a,b,c,d){var e=_Vec3();e[0]=2*c[0]/d[2]-1,e[1]=-2*c[1]/d[3]+1,e[2]=c[2];var f=_Mat4();mat4_inverse(f,b),mat4_mul_point(a,f,e),mat4_stack.index--,vec3_stack.index--}function get_mouse_world_position(a,b){var c=_Vec3();vec_eq(c,input.mouse.position),c[0]*=app.res,c[1]*=app.res,screen_to_world(a,b.view_projection,c,app.view)}function world_camera_rect(a,b,c){var d=vec3_stack.index,e=_Vec3(),f=_Vec3(c[2],c[3]),g=_Vec3(),h=_Vec3();screen_to_world(g,b,e,c),screen_to_world(h,b,f,c),a[2]=h[0]-g[0],a[3]=h[1]-g[1],vec3_stack.index=d}function Shader(a,b){var c={};return c.id=null,c.attributes={},c.uniforms={},c.props={},c.vertex_src=a,c.fragment_src=b,c}function read_shader(a){var b=read_string(),c=read_string(),d=read_string(),e=Shader(c,d);return e.name=b,a&&(a.shaders[b]=e),e}function VertexAttribute(a,b){var c={};return c.size=a,c.normalized=b||!1,c.offset=0,c}function VertexBuffer(a,b,c){var d={};d.id=null,d.data=a,d.stride=0;for(var e in b){var f=b[e];f.offset=d.stride,d.stride+=f.size}return d.attributes=b,d.offset=0,d.count=0,d.capacity=0,d.update_rate=c||BufferUpdateRate.STATIC,a&&(d.count=d.data.length/d.stride,d.capacity=d.data.length/d.stride),d}function alloc_vertex_buffer_memory(a,b){a.data=new Float32Array(b*a.stride),a.count=a.data.length/a.stride,a.capacity=a.data.length/a.stride}function resize_vertex_buffer(a,b,c){if(null===a)alloc_vertex_buffer_memory(a,b);else{var d=new Float32Array(a.stride*b);c&&d.set(a.data),a.data=d,a.count=a.data.length/a.stride,a.capacity=a.data.length/a.stride}}function copy_vertex_attribute(a,b,c,d){for(var e=b.attributes[c].size,f=d*b.stride,g=f+e,h=f;h<g;++h)a[h]=b.data[h]}function zero_buffer(a){for(var b=a.length,c=0;c<b;++c)a[c]=0}function clear_mesh_buffers(a){a.vertex_buffer.offset=0,zero_buffer(a.vertex_buffer.data),null!==a.index_buffer&&(a.index_buffer.offset=0,a.index_buffer.triangle_offset=0,zero_buffer(a.index_buffer.data))}function IndexBuffer(a,b){var c={};return c.id=null,c.data=a,c.count=0,c.offset=0,c.triangle_offset=0,a&&(c.count=c.data.length),c.update_rate=b||BufferUpdateRate.STATIC,c}function alloc_index_buffer_memory(a,b){a.data=new Uint32Array(b),a.count=b}function resize_index_buffer(a,b,c){if(null===a)alloc_index_buffer_memory(a,b);else{var d=new Uint32Array(b);c&&d.set(a.data),a.data=d,a.count=a.data.length}}function InstancedVertexBuffer(a,b,c){var d={};return d.id=null,d.data=a,d.stride=b,d.normalized=c,d.count=a.length/b,d}function Mesh(a,b,c){var d={};return d.vertex_buffer=a,d.index_buffer=b,d.layout=c||MeshLayout.TRIANGLES,d}function read_mesh(a){var b=read_string(),c=read_i32(),d=read_f32(c),e=read_i32(),f=null;e>0&&(f=read_u32(e));for(var g={},h=read_i32(),i=0;i<h;++i){var j=read_string(),k=read_i32(),l=read_boolean();g[j]=VertexAttribute(k,l)}var m=VertexBuffer(d,g),n=null;f&&(n=IndexBuffer(f));var o=Mesh(m,n,MeshLayout.TRIANGLES);return o.name=b,a&&(a.meshes[b]=o),o}function Sampler(a,b,c,d,e){var f={};return f.s=a,f.t=b,f.up=c,f.down=d,f.anisotropy=e,f}function default_sampler(){return Sampler(GL.CLAMP_TO_EDGE,GL.CLAMP_TO_EDGE,GL.LINEAR,GL.LINEAR,16)}function Texture(a,b,c,d,e,f){var g={};return g.id=null,g.data=c,g.format=e,g.width=a,g.height=b,g.bytes_per_pixel=f,g.compressed=!1,g.from_element=!1,g.sampler=d,g.flip=!1,g.loaded=!1,g.gl_releasable=!1,g}function texture_from_dom(a,b,c,d){c=c||TextureFormat.RGBA;var e=Texture(a.width,a.height,a,b,c,4);return e.from_element=!0,e.use_mipmaps=!1,e.flip=d||!1,e}function rgba_texture(a,b,c,d){var e=Texture(a,b,c,d,TextureFormat.RGBA,4);return e}function depth_texture(a,b,c){var d=Texture(a,b,null,c,TextureFormat.DEPTH,4);return d}function read_texture(a,b){var c=read_string(),d=read_f64(),e=read_bytes(d),f=new Image,g="data:image/"+a+";base64,";f.src=g+uint8_to_base64(e);var h=Texture(f.width,f.height,f,app.sampler,TextureFormat.RGBA,4);return h.from_element=!0,h.use_mipmaps=!1,h.flip=!0,b&&(b.textures[c]=h),h}function RenderTarget(a,b){var c={};return c.frame_buffer=null,c.render_buffer=null,c.color=rgba_texture(a[2],a[3],null,b),c.depth=depth_texture(a[2],a[3],b),c.view=a,bind_render_target(c),c}function TextMesh(a,b,c){var d=Entity();d.font=a,d.color=Vec4(.2,.2,.2,1),d.index=0,d.size=.016,d.str="",d.px=0,d.py=0,d.letter_spacing=0,d.width=0,d.height=0,d.horizontal_alignment=TextHorizontalAlignment.CENTER;var e={position:VertexAttribute(2),uv:VertexAttribute(2),color:VertexAttribute(4),index:VertexAttribute(1)};c=c||b.length;var f=VertexBuffer(null,e);alloc_vertex_buffer_memory(f,4*c);var g=IndexBuffer(null);return alloc_index_buffer_memory(g,6*c),d.mesh=Mesh(f,g,MeshLayout.TRIANGLES),bind_mesh(d.mesh),b&&set_text_mesh(d,b),d}function push_glyph_vertex(a,b,c,d,e,f,g){var h=a.offset,i=a.data;i[h]=b,i[h+1]=c,i[h+2]=d,i[h+3]=e,i[h+4]=f[0],i[h+5]=f[1],i[h+6]=f[2],i[h+7]=f[3],i[h+8]=g,a.offset+=9,a.count=a.offset}function add_glyph(a,b,c,d,e){var f=a.font,g=f.glyphs,h=d*f.glyph_stride,i=g[h+0],j=g[h+1],k=f.grid_width*b,l=k,m=g[h+2]*b,n=g[h+3]*b,o=g[h+4]*b,p=g[h+5]*b,q=g[h+6]*b,r=l/2,s=k/2,t=0;e>0&&(t=get_kerning(f,e,d),t*=b);var u=i/f.atlas.width,v=j/f.atlas.height,w=u+f.grid_width/f.atlas.width,x=v+f.grid_width/f.atlas.height,y=a.px+o+t+m/2+a.letter_spacing,z=a.py+p-n/2,A=y-s,B=y+s,C=z+r,D=z-r,E=a.mesh.vertex_buffer;push_glyph_vertex(E,A,D,u,v,c,a.index),push_glyph_vertex(E,B,D,w,v,c,a.index),push_glyph_vertex(E,A,C,u,x,c,a.index),push_glyph_vertex(E,B,C,w,x,c,a.index);var F=a.mesh.index_buffer,G=F.triangle_offset,H=F.data,I=F.offset;H[I]=G+0,H[I+1]=G+1,H[I+2]=G+3,H[I+3]=G+0,H[I+4]=G+3,H[I+5]=G+2,F.offset+=6,F.triangle_offset+=4,F.count=F.offset,a.px+=q+t+a.letter_spacing,a.index++,a.width=a.px-a.letter_spacing}function reset_text(a){clear_mesh_buffers(a.mesh),a.px=0,a.py=0,a.width=0,a.height=0,a.index=0}function update_text_mesh(a){reset_text(a),append_text(a,a.str,a.size,a.color)}function set_text_mesh(a,b,c,d){a.str=b,reset_text(a),append_text(a,b,c||a.size,d||a.color)}function append_text(a,b,c,d){for(var e=b.length,f=-1,g=0;g<e;++g){var h=b.charCodeAt(g);add_glyph(a,c,d,h,f),f=h}align_text_mesh(a,a.horizontal_alignment),update_mesh(a.mesh)}function align_text_mesh(a,b,c,d){var e=0;switch(b){case TextHorizontalAlignment.CENTER:e=-a.width/2-a.letter_spacing;break;case TextHorizontalAlignment.RIGHT:e=-a.width}for(var f=a.mesh.vertex_buffer,g=(c||0)*f.stride,h=(d||f.count/f.stride)*f.stride,i=g;i<h;i+=f.stride)f.data[i]+=e}function draw_text(a,b,c){use_shader(b);var d=_Mat4();mat4_mul(d,a.world_matrix,c.view_projection),set_uniform("mvp",d),set_uniform("texture",a.font.atlas),draw_mesh(a.mesh),mat4_stack.index--}function Font(){var a={};return a.name,a.atlas=null,a.num_glyphs,a.grid_width,a.glyph_stride,a.num_glyphs,a.has_kerning,a.num_kerning_values,a.max_tries,a.glyhs,a}function get_kerning(a,b,c){var d=0,e=5381;e=(e<<5)+e+b,e=(e<<5)+e+c,e%=a.kerning_table_size;for(var f=a.num_tries;;){if(0===f)break;f--;var g=a.indices[e];if(g===-1)break;if(a.a_keys[g]===b&&a.b_keys[g]===c){d=a.kerning[g];break}e++}return d}function read_font(a){var b=Font();return b.name=read_string(),b.num_glyphs=read_i32(),b.grid_width=read_i32(),b.glyph_stride=read_i32(),b.glyphs=read_f32(b.num_glyphs*b.glyph_stride),b.has_kerning=read_boolean(),b.has_kerning===!0&&(b.kerning_table_size=read_i32(),b.num_kerning_values=read_i32(),b.max_tries=read_i32(),b.indices=read_i32(b.kerning_table_size),b.a_keys=read_i32(b.num_kerning_values),b.b_keys=read_i32(b.num_kerning_values),b.kerning=read_f32(b.num_kerning_values)),b.atlas=read_texture("png"),a&&(a.fonts[b.name]=b),b}function Entity(a,b,c,d){var e={};return e.name,e.id=_ENTITY_COUNT,_ENTITY_COUNT++,e.parent=null,e.children=[],e.active=!0,e.dirty=!0,e.position=Vec3(a,b,c),e.world_position=Vec3(),e.scale=Vec3(1,1,1),e.rotation=Vec4(0,0,0,1),e.local_matrix=Mat4(),e.world_matrix=Mat4(),d&&set_parent(e,d),e}function set_mvp(a,b,c){mat4_mul(a,b.world_matrix,c.view_projection)}function set_active(a,b){a.active=b;for(var c=a.children.length,d=0;d<c;++d)entity_set_active(a.children[d],b)}function set_parent(a,b){a.parent!==b&&(null!==a.parent&&null===b?(b.children.splice(b.children.indexOf(a,0),1),a.parent=null):null!==a.parent&&null!==b?(a.parent.children.splice(a.parent.children.indexOf(a,0),1),a.parent=b,b.children.push(a)):(a.parent=b,b.children.push(a)))}function get_position(a,b){mat4_get_position(a,b.world_matrix)}function get_scale(a,b){mat4_get_scale(a,b.world_matrix)}function get_rotation(a,b){mat4_get_rotation(a,b.world_matrix)}function rotate_entity(a,b){var c=_Vec4();quat_set_euler(c,b),quat_mul(a.rotation,c,a.rotation)}function update_entity(a,b){mat4_compose(a.local_matrix,a.position,a.scale,a.rotation),null===a.parent?vec_eq(a.world_matrix,a.local_matrix):mat4_mul(a.world_matrix,a.local_matrix,a.parent.world_matrix),mat4_mul_point(a.world_position,a.world_matrix,a.position);for(var c=a.children.length,d=0;d<c;++d){var e=mat4_stack.index;update_entity(a.children[d],!0),mat4_stack.index=e}}function Camera(a,b,c,d,e){var f=Entity(0,0,0);return f.projection=Mat4(),f.view=Mat4(),f.view_projection=Mat4(),f.normal=Mat3(),f.mask=0,f.aspect=1,f.near=a,f.far=b,f.fov=c,f.size=1,f.ortho=e||!1,update_camera_projection(f,d),f}function UICamera(a){var b=Camera(.01,1,60,a,!0);return set_vec3(b.position,a[2]/2,a[3]/2,0),b}function update_camera_projection(a,b){a.aspect=b[2]/b[3],a.ortho?(a.size=b[3],ortho_projection(a.projection,a.size*a.aspect,a.size,a.near,a.far)):perspective_projection(a.projection,a.near,a.far,a.aspect,a.fov)}function update_camera(a){update_entity(a,!0),mat4_inverse_affine(a.view,a.world_matrix),mat4_mul(a.view_projection,a.view,a.projection)}function Canvas(a,b){var c=document.createElement("canvas");return c.width=b[2],c.height=b[3],a.appendChild(c),c}function WebGL(a,b){if(GL=a.getContext("webgl",b),!GL)return console.error("Webgl not supported"),!1;GL.extensions={};for(var c=GL.getSupportedExtensions(),d=0;d<c.length;++d){var e=c[d];e.startsWith("MOZ")||(GL.extensions[e]=GL.getExtension(e))}return GL._parameters={},GL._parameters.num_texture_units=GL.getParameter(GL.MAX_TEXTURE_IMAGE_UNITS),GL.clearColor(1,1,1,1),GL.enable(GL.SCISSOR_TEST),reset_webgl_state(GL),GL}function reset_webgl_state(a){for(var b=a._parameters.num_texture_units,c=0;c<b;++c)a.activeTexture(a.TEXTURE0+c),a.bindTexture(a.TEXTURE_2D,null),a.bindTexture(a.TEXTURE_CUBE_MAP,null);a.bindBuffer(a.ARRAY_BUFFER,null),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),a.bindRenderbuffer(a.RENDERBUFFER,null),a.bindFramebuffer(a.FRAMEBUFFER,null),enable_backface_culling(),enable_depth_testing(a.LEQUAL),set_blend_mode(BlendMode.DEFAULT)}function set_viewport(a){GL.viewport(a[0],a[1],a[2],a[3]),GL.scissor(a[0],a[1],a[2],a[3])}function set_clear_color(a,b,c,d){GL.clearColor(a,b,c,d)}function clear_screen(){GL.clear(GL.COLOR_BUFFER_BIT|GL.DEPTH_BUFFER_BIT)}function enable_backface_culling(){GL.enable(GL.CULL_FACE),GL.cullFace(GL.BACK),GL.frontFace(GL.CCW)}function disable_backface_culling(){GL.disable(GL.CULL_FACE)}function enable_depth_testing(a){GL.enable(GL.DEPTH_TEST),a&&GL.depthFunc(a)}function disable_depth_testing(){GL.disable(GL.DEPTH_TEST)}function set_depth_range(a,b){GL.depthRange(a,b)}function set_line_width(a){GL.lineWidth(a)}function convert_update_rate(a){switch(a){case BufferUpdateRate.STATIC:return GL.STATIC_DRAW;case BufferUpdateRate.DYNAMIC:return GL.DYNAMIC_DRAW;case BufferUpdateRate.STREAM:return GL.STREAM_DRAW;default:console.error("Invalid update rate")}}function convert_mesh_layout(a){switch(a){case MeshLayout.TRIANGLES:return GL.TRIANGLES;case MeshLayout.LINES:return GL.LINES;case MeshLayout.TRI_STRIP:return GL.TRIANGLE_STRIP;default:console.error("Invalid mesh layout")}}function bind_mesh(a){null===a.vertex_buffer.id&&(a.vertex_buffer.id=GL.createBuffer()),null!==a.index_buffer&&null===a.index_buffer.id&&(a.index_buffer.id=GL.createBuffer())}function unbind_mesh(a){GL.bindBuffer(GL.ARRAY_BUFFER,a.vertex_buffer.id),GL.bufferData(GL.ARRAY_BUFFER,1,GL.STATIC_DRAW),GL.deleteBuffer(a.vertex_buffer.id),a.index_buffer&&(GL.bindBuffer(GL.ELEMENT_ARRAY_BUFFER,a.index_buffer.id),GL.bufferData(GL.ELEMENT_ARRAY_BUFFER,1,GL.STATIC_DRAW),GL.deleteBuffer(a.index_buffer.id)),a.vertex_buffer.id=null,a.index_buffer.id=null,GL.bindBuffer(GL.ARRAY_BUFFER,null),GL.bufferData(GL.ELEMENT_ARRAY_BUFFER,null)}function update_mesh(a){var b=a.vertex_buffer,c=a.index_buffer;GL.bindBuffer(GL.ARRAY_BUFFER,b.id),
GL.bufferData(GL.ARRAY_BUFFER,b.data,convert_update_rate(b.update_rate)),GL.bindBuffer(GL.ARRAY_BUFFER,null),null!==c&&(c.byte_size=GL.UNSIGNED_INT,GL.bindBuffer(GL.ELEMENT_ARRAY_BUFFER,c.id),GL.bufferData(GL.ELEMENT_ARRAY_BUFFER,c.data,convert_update_rate(c.update_rate)),GL.bindBuffer(GL.ELEMENT_ARRAY_BUFFER,null))}function update_mesh_range(a,b,c){var d=a.vertex_buffer,e=d.data.subarray(b,c);GL.bindBuffer(GL.ARRAY_BUFFER,d.id),GL.bufferSubData(GL.ARRAY_BUFFER,4*b,e),GL.bindBuffer(GL.ARRAY_BUFFER,null)}function convert_texture_size(a){if(a.format===TextureFormat.DEPTH)return GL.UNSIGNED_SHORT;switch(a.bytes_per_pixel){case 4:return GL.UNSIGNED_BYTE;default:console.error("Invalid texture size")}}function convert_texture_format(a){switch(a){case TextureFormat.RGB:return GL.RGB;case TextureFormat.RGBA:return GL.RGBA;case TextureFormat.DEPTH:return GL.DEPTH_COMPONENT;case TextureFormat.GRAYSCALE:return GL.LUMINANCE;default:console.error("Invalid texture format")}}function bind_texture(a){null===a.id&&(a.id=GL.createTexture())}function unbind_texture(a){GL.deleteTexture(a.id),a.id=null}function update_texture(a){GL.bindTexture(GL.TEXTURE_2D,a.id);var b=convert_texture_size(a),c=convert_texture_format(a.format);a.flip===!0&&GL.pixelStorei(GL.UNPACK_FLIP_Y_WEBGL,!0),a.from_element===!0?GL.texImage2D(GL.TEXTURE_2D,0,c,c,b,a.data):a.compressed===!0?GL.compressedTexImage2D(GL.TEXTURE_2D,0,c,a.width,a.height,0,a.data):GL.texImage2D(GL.TEXTURE_2D,0,c,a.width,a.height,0,c,b,a.data),a.use_mipmaps===!0&&GL.generateMipmap(GL.TEXTURE_2D),set_sampler(a.sampler)}function set_sampler(a){GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_WRAP_S,a.s),GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_WRAP_T,a.t),GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_MIN_FILTER,a.up),GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_MAG_FILTER,a.down);var b=GL.extensions.EXT_texture_filter_anisotropic;if(void 0!==b){var c=GL.getParameter(b.MAX_TEXTURE_MAX_ANISOTROPY_EXT),d=clamp(a.anisotropy,0,c);GL.texParameterf(GL.TEXTURE_2D,b.TEXTURE_MAX_ANISOTROPY_EXT,d)}}function bind_shader(a){if(null===a.id){var b=GL.createShader(GL.VERTEX_SHADER);GL.shaderSource(b,a.vertex_src),GL.compileShader(b);var c=GL.getShaderParameter(b,GL.COMPILE_STATUS);c===!1&&console.error("Shader Compile Error: "+GL.getShaderInfoLog(b));var d=GL.createShader(GL.FRAGMENT_SHADER);GL.shaderSource(d,a.fragment_src),GL.compileShader(d),c=GL.getShaderParameter(d,GL.COMPILE_STATUS),c===!1&&console.error("Shader Compile Error: "+GL.getShaderInfoLog(d)),a.id=GL.createProgram(),GL.attachShader(a.id,b),GL.attachShader(a.id,d),GL.linkProgram(a.id),c=GL.getProgramParameter(a.id,GL.LINK_STATUS),c===!1&&console.error("Shader Link Error: "+GL.getProgramInfoLog(a.id));for(var e=GL.getProgramParameter(a.id,GL.ACTIVE_ATTRIBUTES),f=0;f<e;++f){var g=GL.getActiveAttrib(a.id,f);a.attributes[g.name]=GL.getAttribLocation(a.id,g.name)}e=GL.getProgramParameter(a.id,GL.ACTIVE_UNIFORMS);for(var h=0,f=0;f<e;++f){var i=GL.getActiveUniform(a.id,f),j={};j.location=GL.getUniformLocation(a.id,i.name),j.type=i.type,j.size=i.size,j.type===GL.SAMPLER_2D&&(j.sampler_index=h,h++),a.uniforms[i.name]=j}return a.vertex_src=null,a.fragment_src=null,a}}function unbind_shader(a){}function set_attributes(a,b){var c=b.vertex_buffer;GL.bindBuffer(GL.ARRAY_BUFFER,c.id);for(var d in c.attributes){var e=a.attributes[d],f=c.attributes[d];void 0!==e&&void 0!==f&&(GL.enableVertexAttribArray(e),GL.vertexAttribPointer(e,f.size,GL.FLOAT,f.normalized,4*c.stride,4*f.offset))}}function bind_instance_buffers(a){for(var b in a){var c=a[b];null===c.id&&(c.id=GL.createBuffer())}update_instance_buffers(a)}function update_instance_buffers(a){for(var b in a){var c=a[b];GL.bindBuffer(GL.ARRAY_BUFFER,c.id),GL.bufferData(GL.ARRAY_BUFFER,c.data,GL.STATIC_DRAW)}}function set_instance_attributes(a,b){var c=GL.extensions.ANGLE_instanced_arrays;for(var d in b){var e=b[d],f=a.attributes[d];void 0!==f&&(GL.bindBuffer(GL.ARRAY_BUFFER,e.id),GL.enableVertexAttribArray(f),GL.vertexAttribPointer(f,e.stride,GL.FLOAT,e.normalized,4*e.stride,0),c.vertexAttribDivisorANGLE(f,1))}}function use_shader(a){_active_shader!==a&&(_active_shader=a,GL.useProgram(a.id))}function set_uniform(a,b){var c=_active_shader.uniforms[a],d=c.location,e=c.size;switch(c.type){case GL.FLOAT:return e>1?void GL.uniform1fv(d,b):void GL.uniform1f(d,b);case GL.FLOAT_VEC2:return e>1?void GL.uniform2fv(d,b):void GL.uniform2f(d,b[0],b[1]);case GL.FLOAT_VEC3:return e>1?void GL.uniform3fv(d,b):void GL.uniform3f(d,b[0],b[1],b[2]);case GL.FLOAT_VEC4:return e>1?void GL.uniform4fv(d,b):void GL.uniform4f(d,b[0],b[1],b[2],b[3]);case GL.BOOL:return void(b===!0?GL.uniform1i(d,1):GL.uniform1i(d,0));case GL.FLOAT_MAT2:return void GL.uniformMatrix2fv(d,!1,b);case GL.FLOAT_MAT3:return void GL.uniformMatrix3fv(d,!1,b);case GL.FLOAT_MAT4:return void GL.uniformMatrix4fv(d,!1,b);case GL.SAMPLER_2D:return GL.uniform1i(d,c.sampler_index),GL.activeTexture(GL.TEXTURE0+c.sampler_index),void GL.bindTexture(GL.TEXTURE_2D,b.id);case GL.INT:return e>1?void GL.uniform1iv(d,b):void GL.uniform1i(d,b);case GL.INT_VEC2:return e>1&&GL.uniform2iv(d,b),void GL.uniform2i(d,b[0],b[1]);case GL.INT_VEC3:return e>1&&GL.uniform3iv(d,b),void GL.uniform3i(d,b[0],b[1],b[2]);case GL.INT_VEC4:return e>1&&GL.uniform4iv(d,e,b),void GL.uniform4i(d,b[0],b[1],b[2],b[3]);default:console.error(c.type+" is an unsupported uniform type")}}function draw_mesh(a){set_attributes(_active_shader,a);var b=convert_mesh_layout(a.layout);null!==a.index_buffer?(GL.bindBuffer(GL.ELEMENT_ARRAY_BUFFER,a.index_buffer.id),GL.drawElements(b,a.index_buffer.count,GL.UNSIGNED_INT,0)):GL.drawArrays(b,0,a.vertex_buffer.count)}function draw_mesh_instanced(a,b,c){var d=GL.extensions.ANGLE_instanced_arrays;set_attributes(_active_shader,a),set_instance_attributes(_active_shader,b);var e=convert_mesh_layout(a.layout);null!==a.index_buffer?(GL.bindBuffer(GL.ELEMENT_ARRAY_BUFFER,a.index_buffer.id),d.drawElementsInstancedANGLE(e,a.index_buffer.count,GL.UNSIGNED_INT,0,c)):d.drawArraysInstancedANGLE(e,0,a.vertex_buffer.count,c)}function set_blend_mode(a){switch(a===BlendMode.NONE?GL.disable(GL.BLEND):GL.enable(GL.BLEND),a){case BlendMode.ADD:GL.blendEquation(GL.FUNC_ADD),GL.blendFuncSeparate(GL.SRC_ALPHA,GL.ONE,GL.ONE,GL.ONE_MINUS_SRC_ALPHA);break;case BlendMode.DARKEN:GL.blendEquation(GL.FUNC_SUBTRACT),GL.blendFunc(GL.ONE,GL.ONE);break;case BlendMode.LIGHTEN:GL.blendEquation(GL.FUNC_ADD),GL.blendFunc(GL.ONE,GL.ONE);break;case BlendMode.DIFFERENCE:GL.blendEquation(GL.FUNC_SUBTRACT),GL.blendFunc(GL.ONE,GL.ONE);break;case BlendMode.MULTIPLY:GL.blendEquation(GL.FUNC_ADD),GL.blendFunc(GL.DST_COLOR,GL.ZERO);break;case BlendMode.SCREEN:GL.blendEquation(GL.FUNC_ADD),GL.blendFunc(GL.MINUS_DST_COLOR,GL.ONE);break;case BlendMode.INVERT:GL.blendEquation(GL.FUNC_ADD),GL.blendFuncSeparate(GL.ONE_MINUS_DST_COLOR,GL.ZERO,GL.ONE,GL.ONE_MINUS_SRC_ALPHA);break;default:GL.blendEquation(GL.FUNC_ADD),GL.blendFunc(GL.SRC_ALPHA,GL.ONE_MINUS_SRC_ALPHA)}}function set_depth_mode(a){switch(a){case DepthMode.NEVER:return void GL.depthFunc(GL.NEVER);case DepthMode.LESS:return void GL.depthFunc(GL.LESS);case DepthMode.LESS_OR_EQUAL:return void GL.depthFunc(GL.LEQUAL);case DepthMode.EQUAL:return void GL.depthFunc(GL.EQUAL);case DepthMode.GREATER:return void GL.depthFunc(GL.GREATER);case DepthMode.NOT_EQUAL:return void GL.depthFunc(GL.NOTEQUAL);case DepthMode.GREATER_OR_EQUAL:return void GL.depthFunc(GL.GEQUAL);case DepthMode.ALWAYS:return void GL.depthFunc(GL.ALWAYS);default:return void GL.depthFunc(GL.LESS)}}function bind_render_target(a){bind_texture(a.color),bind_texture(a.depth),update_texture(a.color),update_texture(a.depth),a.frame_buffer=GL.createFramebuffer(),GL.bindFramebuffer(GL.FRAMEBUFFER,a.frame_buffer),set_render_target_attachment(GL.COLOR_ATTACHMENT0,a.color),set_render_target_attachment(GL.DEPTH_ATTACHMENT,a.depth),GL.bindFramebuffer(GL.FRAMEBUFFER,null),GL.bindRenderbuffer(GL.RENDERBUFFER,null)}function set_render_target_attachment(a,b){GL.bindTexture(GL.TEXTURE_2D,b.id),GL.framebufferTexture2D(GL.FRAMEBUFFER,a,GL.TEXTURE_2D,b.id,0)}function set_render_target(a){null===a?(GL.bindFramebuffer(GL.FRAMEBUFFER,null),GL.bindRenderbuffer(GL.RENDERBUFFER,null),set_viewport(app.view)):(GL.bindFramebuffer(GL.FRAMEBUFFER,a.frame_buffer),GL.bindRenderbuffer(GL.RENDERBUFFER,a.render_buffer),set_viewport(a.view))}function Mouse(){var a={};return a.position=Vec3(),a.last_position=Vec3(),a.delta=Vec3(),a.scroll=0,a.dy=0,a.ldy=0,a}function Gyro(){var a={};return a.acceleration=Vec3(),a.angular_acceleration=Vec3(),a.rotation=Vec4(),a.updated=!1,a}function Touch(){var a={};return a.id=-1,a.is_touching=!1,a.position=Vec3(),a.last_position=Vec3(),a.delta=Vec3(),a.updated=!1,a}function GamePad(){var a={};return a}function Input(a){var b={};if(b.is_touch_device=is_touch_device(),a||(a=window),b.is_touch_device===!0){b.touches=[],b.MAX_TOUCHES=5;for(var c=0;c<b.MAX_TOUCHES;++c)b.touches[c]=Touch();a.addEventListener("touchstart",on_touch_start,!1),a.addEventListener("touchmove",on_touch_move,!1),a.addEventListener("touchend",on_touch_end,!1),b.gyro=Gyro(),window.addEventListener("devicemotion",on_device_motion),window.addEventListener("deviceorientation",on_device_rotation)}else b.mouse=Mouse(),b.keys=new Uint8Array(256),window.addEventListener("keydown",on_key_down),window.addEventListener("keyup",on_key_up),window.addEventListener("mouseup",on_key_up),window.addEventListener("mousedown",on_key_down),window.addEventListener("mousemove",on_mouse_move),window.addEventListener("wheel",on_mouse_wheel);return input=b,b}function is_touch_device(){return"ontouchstart"in window||navigator.MaxTouchPoints>0||navigator.msMaxTouchPoints>0}function update_input(){if(input.is_touch_device===!0)for(var a=0;a<input.MAX_TOUCHES;++a){var b=input.touches[a];if(b.is_touching!==!1){b.delta[0]=b.position[0]-b.last_position[0],b.delta[1]=b.position[1]-b.last_position[1],b.last_position[0]=b.position[0],b.last_position[1]=b.position[1];break}}else{for(var a=0;a<256;++a)input.keys[a]===KeyState.DOWN?input.keys[a]=KeyState.HELD:input.keys[a]===KeyState.UP&&(input.keys[a]=KeyState.RELEASED);input.mouse.dy===input.mouse.ldy?input.mouse.scroll=0:(input.mouse.scroll=input.mouse.dy,input.mouse.ldy=input.mouse.dy),vec_sub(input.mouse.delta,input.mouse.position,input.mouse.last_position),vec_eq(input.mouse.last_position,input.mouse.position)}}function key_up(a){return input.keys[a]===KeyState.UP}function key_down(a){return input.keys[a]===KeyState.DOWN}function key_held(a){return input.keys[a]===KeyState.HELD||input.keys[a]===KeyState.DOWN}function key_released(a){return input.keys[a]===KeyState.RELEASED||input.keys[a]===KeyState.UP}function on_key_down(a){var b=a.keyCode||a.button;input.keys[b]!=KeyState.HELD&&(input.keys[b]=KeyState.DOWN)}function on_key_up(a){var b=a.keyCode||a.button;input.keys[b]!=KeyState.RELEASED&&(input.keys[b]=KeyState.UP)}function on_mouse_move(a){set_vec3(input.mouse.position,a.clientX,a.clientY,0)}function on_mouse_wheel(a){input.mouse.dy=a.deltaY}function on_device_motion(a){var b=a.acceleration,c=a.rotationRate;set_vec3(input.gyro.acceleration,b.x,b.y,b.z),set_vec3(input.gyro.angular_acceleration,c.beta,c.gamma,c.alpha),input.gyro.updated=!0}function on_device_rotation(a){quat_set_euler_f(input.gyro.rotation,a.beta,a.gamma,a.alpha),input.gyro.updated=!0}function on_touch_start(a){for(var b=a.changedTouches.length,c=0;c<b;++c)for(var d=a.changedTouches[c],e=0;e<input.MAX_TOUCHES;++e){var f=input.touches[e];if(f.is_touching!==!0){var g=d.screenX,h=d.screenY;set_vec3(f.position,g,h,0),set_vec3(f.last_position,g,h,0),set_vec3(f.delta,0,0,0),f.is_touching=!0,f.id=d.identifier,f.updated=!0;break}}}function on_touch_move(a){for(var b=a.changedTouches.length,c=0;c<b;++c)for(var d=a.changedTouches[c],e=0;e<input.MAX_TOUCHES;++e){var f=input.touches[e];if(d.identifier===f.id){f.is_touching=!0;var g=d.screenX,h=d.screenY;set_vec3(f.position,g,h,0),f.updated=!0;break}}}function on_touch_end(a){for(var b=a.changedTouches.length,c=0;c<b;++c)for(var d=a.changedTouches[c].identifier,e=0;e<input.MAX_TOUCHES;++e){var f=input.touches[e];if(d===f.id){f.is_touching=!1,f.id=-1,f.updated=!0;break}}}function GLDraw(a){var b={};b.color=Vec4(1,1,1,1),b.matrix=Mat4();var c=BufferUpdateRate.DYNAMIC;b.line_shader=app.assets.shaders.basic;var d={position:VertexAttribute(3),color:VertexAttribute(4,!0)},e=VertexBuffer(null,d,c);alloc_vertex_buffer_memory(e,a),b.lines=Mesh(e,null,MeshLayout.LINES),bind_mesh(b.lines),b.tri_shader=app.assets.shaders.rect;var f={position:VertexAttribute(3),uv:VertexAttribute(2),radius:VertexAttribute(1),color:VertexAttribute(4,!0)};e=VertexBuffer(null,f,c),alloc_vertex_buffer_memory(e,a);var g=IndexBuffer(new Uint32Array(a),c);return b.triangles=Mesh(e,g,MeshLayout.TRIANGLES),bind_mesh(b.triangles),b.text_shader=app.assets.shaders.text,b.text_buffer=TextMesh(app.assets.fonts.bebas,null,2048),b}function reset_gl_draw(a){mat4_identity(a.matrix),set_vec4(a.color,1,1,1,1),clear_mesh_buffers(a.lines),clear_mesh_buffers(a.triangles),reset_text(a.text_buffer)}function draw_im_text(a,b,c,d,e){a.text_buffer.px=b,a.text_buffer.py=c,append_text(a.text_buffer,d,e,a.color)}function render_gl_draw(a,b){update_mesh(a.lines),update_mesh(a.triangles),use_shader(a.line_shader),set_uniform("mvp",b.view_projection),draw_mesh(a.lines),use_shader(a.tri_shader),set_uniform("mvp",b.view_projection),draw_mesh(a.triangles),draw_text(a.text_buffer,a.text_shader,b),reset_gl_draw(a)}function gl_push_line(a,b,c,d,e){var f=vec3_stack.index,g=c.vertex_buffer.offset,h=c.vertex_buffer.data,i=d,j=_Vec3(),k=_Vec3();mat4_mul_point(j,e,a),mat4_mul_point(k,e,b),h[g]=j[0],h[g+1]=j[1],h[g+2]=j[2],h[g+3]=i[0],h[g+4]=i[1],h[g+5]=i[2],h[g+6]=i[3],h[g+7]=k[0],h[g+8]=k[1],h[g+9]=k[2],h[g+10]=i[0],h[g+11]=i[1],h[g+12]=i[2],h[g+13]=i[3],vec3_stack.index=f,c.vertex_buffer.offset+=14}function gl_push_line_segment(a,b,c,d,e,f,g){var h=e.vertex_buffer.data,i=e.vertex_buffer.offset,j=f,k=d,l=vec3_stack.index,m=_Vec3();vec_sub(m,b,a),vec_normalized(m,m);var n=_Vec3();vec_perp(n,m),vec_mul_f(n,n,c),h[i]=a[0]-n[0],h[i+1]=a[1]-n[1],h[i+2]=k,h[i+3]=j[0],h[i+4]=j[1],h[i+5]=j[2],h[i+6]=j[3],h[i+7]=b[0]-n[0],h[i+8]=b[1]-n[1],h[i+9]=k,h[i+10]=j[0],h[i+11]=j[1],h[i+12]=j[2],h[i+13]=j[3],h[i+14]=a[0]+n[0],h[i+15]=a[1]+n[1],h[i+16]=k,h[i+17]=j[0],h[i+18]=j[1],h[i+19]=j[2],h[i+20]=j[3],h[i+21]=b[0]+n[0],h[i+22]=b[1]+n[1],h[i+23]=k,h[i+24]=j[0],h[i+25]=j[1],h[i+26]=j[2],h[i+27]=j[3],e.vertex_buffer.offset+=28,h=e.index_buffer.data;var o=e.index_buffer.offset,p=e.index_buffer.triangle_offset;h[o]=p+0,h[o+1]=p+1,h[o+2]=p+3,h[o+3]=p+0,h[o+4]=p+3,h[o+5]=p+2,e.index_buffer.triangle_offset+=4,e.index_buffer.offset+=6,vec3_stack.index=l}function draw_quad(a,b,c,d,e){var f=c/2,g=d/2,h=_Vec4(b[0]-f,b[1]+g,c,d);gl_push_rect(h,b[2],e,a.triangles,a.color,a.matrix),vec4_stack.index--}function draw_quad_f(a,b,c,d,e,f){var g=_Vec4(b,c,d,e);gl_push_rect(g,0,f,a.triangles,a.color,a.matrix),vec4_stack.index--}function gl_push_rect(a,b,c,d,e,f){var g=d.vertex_buffer.data,h=d.vertex_buffer.offset,i=e,j=b;g[h]=a[0],g[h+1]=a[1]-a[3],g[h+2]=j,g[h+3]=0,g[h+4]=0,g[h+5]=c,g[h+6]=i[0],g[h+7]=i[1],g[h+8]=i[2],g[h+9]=i[3],g[h+10]=a[0]+a[2],g[h+11]=a[1]-a[3],g[h+12]=j,g[h+13]=1,g[h+14]=0,g[h+15]=c,g[h+16]=i[0],g[h+17]=i[1],g[h+18]=i[2],g[h+19]=i[3],g[h+20]=a[0],g[h+21]=a[1],g[h+22]=j,g[h+23]=0,g[h+24]=1,g[h+25]=c,g[h+26]=i[0],g[h+27]=i[1],g[h+28]=i[2],g[h+29]=i[3],g[h+30]=a[0]+a[2],g[h+31]=a[1],g[h+32]=j,g[h+33]=1,g[h+34]=1,g[h+35]=c,g[h+36]=i[0],g[h+37]=i[1],g[h+38]=i[2],g[h+39]=i[3],d.vertex_buffer.offset+=40,g=d.index_buffer.data;var k=d.index_buffer.offset,l=d.index_buffer.triangle_offset;g[k]=l+0,g[k+1]=l+1,g[k+2]=l+3,g[k+3]=l+0,g[k+4]=l+3,g[k+5]=l+2,d.index_buffer.triangle_offset+=4,d.index_buffer.offset+=6}function draw_line(a,b,c){gl_push_line(b,c,a.lines,a.color,a.matrix)}function draw_point(a,b,c){var d=vec3_stack.index,e=_Vec3(b[0]-c,b[1],b[2]),f=_Vec3(b[0]+c,b[1],b[2]),g=_Vec3(b[0],b[1]-c,b[2]),h=_Vec3(b[0],b[1]+c,b[2]);gl_push_line(e,f,a.lines,a.color,a.matrix),gl_push_line(h,g,a.lines,a.color,a.matrix),vec3_stack.index=d}function draw_normal(a,b,c,d){var e=_Vec3();vec_mul_f(e,c,d),vec_add(e,b,e),gl_push_line(b,e,a.lines,a.color,a.matrix)}function draw_ray(a,b){var c=_Vec3();vec_mul_f(c,b.direction,b.length),vec_add(c,b.origin,c),gl_push_line(b.origin,c,a.lines,a.color,a.matrix)}function draw_wire_rect(a,b){var c=vec3_stack.index,d=_Vec3(b[0],b[1]),e=_Vec3(b[0],b[1]+b[3]),f=_Vec3(b[0]+b[2],b[1]+b[3]),g=_Vec3(b[0]+b[2],b[1]);gl_push_line(d,e,a.lines,a.color,a.matrix),gl_push_line(e,f,a.lines,a.color,a.matrix),gl_push_line(f,g,a.lines,a.color,a.matrix),gl_push_line(g,d,a.lines,a.color,a.matrix),vec3_stack.index=c}function draw_wire_cube(a,b,c,d){var e=b/2,f=c/2,g=d/2,h=_Vec3,i=gl_push_line,j=a.lines,k=a.color,l=a.matrix,m=vec3_stack.index;i(h(-e,-f,-g),h(-e,f,-g),j,k,l),i(h(-e,f,-g),h(e,f,-g),j,k,l),i(h(e,f,-g),h(e,-f,-g),j,k,l),i(h(e,-f,-g),h(-e,-f,-g),j,k,l),i(h(-e,-f,g),h(-e,f,g),j,k,l),i(h(-e,f,g),h(e,f,g),j,k,l),i(h(e,f,g),h(e,-f,g),j,k,l),i(h(e,-f,g),h(-e,-f,g),j,k,l),i(h(-e,-f,-g),h(-e,-f,g),j,k,l),i(h(-e,f,-g),h(-e,f,g),j,k,l),i(h(e,f,-g),h(e,f,g),j,k,l),i(h(e,-f,-g),h(e,-f,g),j,k,l),vec3_stack.index=m}function draw_wire_circle(a,b,c){for(var d=TAU/c,e=Math.tan(d),f=Math.cos(d),g=vec3_stack.index,h=_Vec3(b,0,0),i=_Vec3(b,0,0),j=0;j<c+1;++j){gl_push_line(i,h,a.lines,a.color,a.matrix),vec_eq(i,h);var k=-h[1],l=h[0];h[0]+=k*e,h[1]+=l*e,h[0]*=f,h[1]*=f}vec3_stack.index=g}function draw_wire_sphere(a,b){var c=_Vec4();draw_wire_circle(b,32),quat_set_euler_f(c,0,90,0),mat4_set_rotation(a.matrix,c),draw_wire_circle(a,b,32),quat_set_euler_f(c,90,0,0),mat4_set_rotation(a.matrix,c),draw_wire_circle(a,b,32),mat4_identity(a.matrix)}function draw_transform(a,b){var c=vec3_stack.index,d=_Vec3(),e=_Vec3();mat4_get_position(d,b),set_vec4(a.color,1,0,0,1),mat4_mul_point(e,b,_Vec3(1,0,0)),gl_push_line(d,e,a.lines,a.color,a.matrix),set_vec4(a.color,0,1,0,1),mat4_mul_point(e,b,_Vec3(0,1,0)),gl_push_line(d,e,a.lines,a.color,a.matrix),set_vec4(a.color,0,0,1,1),mat4_mul_point(e,b,_Vec3(0,0,1)),gl_push_line(d,e,a.lines,a.color,a.matrix),vec3_stack.index=c}function draw_bounds(a,b){mat4_identity(a.matrix);var c=_Vec3();aabb_center(c,b),mat4_set_position(a.matrix,c);var d=ab.width(b),e=ab.height(b),f=ab.depth(b);draw_wire_cube(a,d,e,f),mat4_identity(a.matrix)}function draw_wire_mesh(a,b,c){for(var d=b.vertex_buffer.data,e=b.index_buffer.data,f=b.index_buffer.count/3,g=b.vertex_buffer.stride,h=_Vec3(),i=_Vec3(),j=_Vec3(),k=0,l=0;l<f;++l){var m=e[k]*g,n=e[k+1]*g,o=e[k+2]*g;set_vec3(h,d[m],d[m+1],d[m+2]),set_vec3(i,d[n],d[n+1],d[n+2]),set_vec3(j,d[o],d[o+1],d[o+2]),gl_push_line(h,i,a.lines,a.color,a.matrix),gl_push_line(i,j,a.lines,a.color,a.matrix),gl_push_line(j,h,a.lines,a.color,a.matrix),k+=3}vec3_stack.index-=3}function draw_wire_camera(a,b){var c=vec3_stack.index;vec_eq(a.matrix,b.world_matrix);var d=1,e=1,f=0,g=_Vec3(0,0,1),h=_Vec3(-d,e,f),i=_Vec3(d,e,f),j=_Vec3(-d,-e,f),k=_Vec3(d,-e,f),l=_Mat4();mat4_inverse(l,b.projection),mat4_mul_point(h,l,h),mat4_mul_point(i,l,i),mat4_mul_point(j,l,j),mat4_mul_point(k,l,k),set_vec4(a.color,.5,.5,.5,1),draw_line(a,g,h),draw_line(a,g,i),draw_line(a,g,j),draw_line(a,g,k),draw_line(a,h,i),draw_line(a,i,k),draw_line(a,k,j),draw_line(a,j,h),set_vec3(j,.3*-d,e+.1,f),set_vec3(k,.3*d,e+.1,f),set_vec3(h,0,e+.5,f),mat4_mul_point(h,l,h),mat4_mul_point(j,l,j),mat4_mul_point(k,l,k),draw_line(a,j,h),draw_line(a,h,k),draw_line(a,k,j),mat4_identity(a.matrix),vec3_stack.index=c}function draw_bezier(a,b,c){var d=vec3_stack.index,e=_Vec3();bezier_eval(e,b,0);for(var f=1/c,g=f,h=1;h<c+1;++h){var i=_Vec3();bezier_eval(i,b,g),gl_push_line(e,i,a.lines,a.color,a.matrix),vec_eq(e,i),g+=f}vec3_stack.index=d}function draw_rig(a,b){for(var c=b.joints.length,d=_Vec3(),e=_Vec3(),f=0;f<c;++f){var g=b.joints[f];if(g.parent!==-1&&0!==g.parent){var h=b.joints[g.parent];mat4_get_position(d,h.world_matrix),mat4_get_position(e,g.world_matrix),gl_push_line(d,e,a.lines,a.color,a.matrix)}}}function draw_rig_transforms(a,b){for(var c=b.joints.length,d=0;d<c;++d)draw_transform(a,b.joints[d].world_matrix)}function quad_mesh(a,b){var c=a/2,d=b/2,e={position:VertexAttribute(2,!1),uv:VertexAttribute(2,!1)},f=new Float32Array([-c,-d,0,0,c,-d,1,0,c,d,1,1,-c,-d,0,0,c,d,1,1,-c,d,0,1]),g=VertexBuffer(f,e),h=Mesh(g,null,MeshLayout.TRIANGLES);return bind_mesh(h),update_mesh(h),h}function cube_mesh(a,b,c){var d=a/2,e=b/2,f=c/2,g={position:VertexAttribute(3,!1),mask:VertexAttribute(1,!1)},h=new Float32Array([-d,-e,f,0,d,-e,f,0,d,e,f,0,-d,e,f,0,-d,-e,-f,1.1,-d,e,-f,1.1,d,e,-f,1.1,d,-e,-f,1.1,-d,e,-f,2.1,-d,e,f,2.1,d,e,f,2.1,d,e,-f,2.1,-d,-e,-f,3.1,d,-e,-f,3.1,d,-e,f,3.1,-d,-e,f,3.1,d,-e,-f,4.1,d,e,-f,4.1,d,e,f,4.1,d,-e,f,4.1,-d,-e,-f,5.1,-d,-e,f,5.1,-d,e,f,5.1,-d,e,-f,5.1]),i=new Uint32Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]),j=VertexBuffer(h,g),k=IndexBuffer(i),l=Mesh(j,k,MeshLayout.TRIANGLES);return bind_mesh(l),update_mesh(l),l}function Preloader(a){var b={};return b.loaded_bytes=0,b.load_percent=0,b.svg=document.querySelector(".preloader"),b.loading_bar=document.querySelector(".preloader-bar"),b}function update_preloader(a,b){a.loading_bar.style.width=Math.floor(94*b)}function hide_preloader(a){a.svg.style.display="none"}function main(){window.addEventListener("focus",function(){console.log("FOCUS"),app.has_focus=!0}),window.addEventListener("blur",function(){console.log("BLUR"),app.has_focus=!1}),app.has_focus=!0,app.state=AppState.INIT,app.preloader=Preloader(app.container),app.assets_loaded=!1;var a=Request("arraybuffer","assets/assets.bin");a.onprogress=function(a){var b=a.loaded/a.total;update_preloader(app.preloader,b)},a.onload=function(a){app.assets_loaded=!0,init_webgl(a.target.response)},a.send()}function init_webgl(a){hide_preloader(app.preloader),app.res=window.devicePixelRatio;var b=document.querySelector(".app");app.container=b;var c=b.clientWidth,d=b.clientHeight,e=c*app.res,f=d*app.res;app.time=Time(),app.view=Vec4(0,0,e,f),app.canvas=Canvas(b,app.view);var g=-((e-c)/2),h=-((f-d)/2);app.canvas.style.transform="translateX("+g+"px) translateY("+h+"px) scale("+1/app.res+")",app.input=Input(),app.webgl=WebGL(app.canvas,{alpha:!1,depth:!0,stencil:!1,antialias:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,preferLowPowerToHighPerformance:!1,failIfMajorPerformanceCaveat:!1}),app.sampler=default_sampler(),app.assets=read_asset_file(a),init()}function init(){var a=app.assets;bind_assets(a),app.gl_draw=GLDraw(12e3),a.meshes.screen_quad=quad_mesh(2,2),a.meshes.cube=cube_mesh(1,1,1),app.root=Entity(0,0,0,null),app.cube=Entity(0,0,0,app.root),rotate_entity(app.cube,_Vec3(30,30,30)),app.normals=[Vec3(0,0,1),Vec3(0,0,-1),Vec3(0,1,0),Vec3(0,-1,0),Vec3(1,0,0),Vec3(-1,0,0)],app.image_names=["fire","stars","beach","falcon","lake","aurora"];var b={};b.spin=Vec3(0,0,0),b.expanded=!1,b.src_rotation=Vec4(),b.target_rotation=Vec4(),b.target_ease_time=0,b.angle_delta=0,b.from_image_index=0,b.to_image_index=0,app.cube_state=b,app.camera=Camera(.01,50,10,app.view),update_camera(app.camera),app.display_text=TextMesh(a.fonts.bebas,app.image_names[0],15),set_parent(app.display_text,app.root),set_vec3(app.display_text.position,0,-.18,0),app.text_target=RenderTarget(app.view,app.sampler),app.cube_target=RenderTarget(app.view,app.sampler),set_vec3(app.camera.position,0,0,20),set_clear_color(1,1,1,1),set_viewport(app.view),clear_stacks(),requestAnimationFrame(update)}function update(a){if(set_time(app.time,a),requestAnimationFrame(update),app.time.paused!==!0&&app.has_focus!==!1&&app.assets_loaded!==!1){for(var b=app.time.dt,c=app.cube_state,d=_Vec3(0,0,1),e=0;e<6;++e){var f=compare_normal(app.normals[e],d,app.cube.rotation);if(f>40){e!==c.to_image_index&&(c.from_image_index=c.to_image_index,c.to_image_index=e,set_text_mesh(app.display_text,app.image_names[e]));break}}var g=input.mouse,h=key_down(Keys.SPACE)||g.scroll<-1,i=key_down(Keys.SPACE)||g.scroll>1;(h||i)&&(c.input_idle_time=0);var j=h===!0&&c.expanded===!1,k=i===!0&&c.expanded===!0;if(j===!0){c.spin[0]=0,c.spin[1]=0,vec_eq(c.src_rotation,app.cube.rotation);var l=_Vec3();quat_get_euler(l,app.cube.rotation);var m=snap_angle(l[0],90),n=snap_angle(l[1],90),o=snap_angle(l[2],90),p=Math.abs(m-l[0]),q=Math.abs(n-l[1]),r=Math.abs(o-l[2]);quat_set_euler_f(c.target_rotation,m,n,o),c.angle_delta=p,q>p&&(c.angle_delta=q),r>q&&(c.angle_delta=r),c.angle_delta=c.angle_delta/360*5,c.angle_delta=clamp(c.angle_delta,0,.5),c.target_ease_time=0,c.expanded=!0}if(k===!0&&(c.target_ease_time=0,c.expanded=!1),c.expanded===!0){c.target_ease_time+=b,c.target_ease_time=clamp(c.target_ease_time,0,1);var s=clamp(3*c.target_ease_time,0,1);quat_slerp(app.cube.rotation,c.src_rotation,c.target_rotation,s);var t=clamp(c.target_ease_time-c.angle_delta,0,1);vec_lerp(app.cube.scale,app.cube.scale,_Vec3(6.5,6.5,6.5),t);var u=app.display_text;vec_lerp(u.scale,u.scale,_Vec3(.7,.7,1),1.5*t),u.letter_spacing=lerp(u.letter_spacing,.6,1.5*t),update_text_mesh(u)}else{var v=2;if(key_held(Keys.MOUSE_LEFT)&&(c.input_idle_time=0,c.spin[1]+=g.delta[0]*v*b,c.spin[0]+=g.delta[1]*v*b),c.spin[0]*=.9,c.spin[1]*=.9,rotate_entity(app.cube,c.spin),c.input_idle_time+=.2*b,c.input_idle_time=clamp(c.input_idle_time,0,1),c.target_ease_time+=b,c.target_ease_time>1){var w=1;w=app.time.st>0?lerp(app.cube.scale[0],1.3,b):lerp(app.cube.scale[0],1.2,b),set_vec3(app.cube.scale,w,w,w)}else{vec_lerp(app.cube.scale,app.cube.scale,_Vec3(1.2,1.2,1.2),c.target_ease_time);var u=app.display_text;vec_lerp(u.scale,u.scale,_Vec3(1,1,1),c.target_ease_time),u.letter_spacing=lerp(u.letter_spacing,0,c.target_ease_time),update_text_mesh(u)}}update_entity(app.root),update_camera(app.camera),render(),update_input(),clear_stacks(),verify_webgl_context()}}function render(){var a=app.assets.shaders,b=app.assets.meshes,c=app.assets.textures,d=app.camera,e=_Mat4();app.view[2]/app.view[3];disable_depth_testing(),set_render_target(app.cube_target),clear_screen(),use_shader(a.cube_mask),set_mvp(e,app.cube,d),set_uniform("mvp",e),set_uniform("resolution",_Vec3(app.view[2],app.view[3]));for(var g=0;g<6;++g)set_uniform("image_"+g,c["hero"+(g+1)]);draw_mesh(b.cube),set_render_target(app.text_target),clear_screen(),draw_text(app.display_text,a.text,d),set_render_target(null),clear_screen(),use_shader(a.composite),set_uniform("cube",app.cube_target.color),set_uniform("text",app.text_target.color),draw_mesh(b.screen_quad)}var _stacks=[],Stack=function(a,b){this.data=[],this.index=0,this.count=b;for(var c=0;c<b;++c)this.data.push(new a);return _stacks.push(this),this};Stack.prototype.get=function(){var a=this.data[this.index];return this.index++,a};var _BR,AssetType={SHADER:0,SCENE:1,FONT:2,PNG:3,JPG:15,CAMERA:4,LAMP:5,MESH:6,MATERIAL:7,ACTION:8,ENTITY:9,EMPTY:10,RIG:11,RIG_ACTION:12,CURVE:13,CUBEMAP:14,END:-1},E=2.718281828459045,PI=3.141592653589793,TAU=6.28318530718,DEG2RAD=.01745329251,RAD2DEG=57.2957795,PI_OVER_360=.00872664625,PI_OVER_TWO=PI/2,PI_OVER_FOUR=PI/4,TWO_PI=2*PI,FOUR_PI=4*PI,EPSILON=2.220446049250313e-16,vec3_stack=new Stack(Vec3,32),vec4_stack=new Stack(Vec4,32),mat3_stack=new Stack(Mat3,16),mat4_stack=new Stack(Mat4,16),MeshLayout={TRIANGLES:0,LINES:1,TRI_STRIP:2},BufferUpdateRate={STATIC:0,DYNAMIC:1,STREAM:2},TextureFormat={RGB:0,RGBA:1,DEPTH:2,GRAYSCALE:3},TextHorizontalAlignment={LEFT:0,CENTER:1,RIGHT:2},TextVerticalAlignment={TOP:0,CENTER:1,BOTTOM:2},_ENTITY_COUNT=0,GL=null,_active_shader=null,BlendMode={DEFAULT:0,NONE:1,DARKEN:2,LIGHTEN:3,DIFFERENCE:4,MULTIPLY:5,SCREEN:6,INVERT:7},DepthMode={DEFAULT:0,NEVER:1,LESS:2,LESS_OR_EQUAL:3,EQUAL:4,GREATER:5,NOT_EQUAL:6,GREATER_OR_EQUAL:7,ALWAYS:8},KeyState={RELEASED:0,UP:1,DOWN:2,HELD:3},Keys={MOUSE_LEFT:0,MOUSE_RIGHT:1,BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,CAPS:20,ESC:27,SPACE:32,LEFT:37,UP:38,RIGHT:39,DOWN:40,ZERO:48,ONE:49,TWO:50,THREE:51,FOUR:52,FIVE:53,SIX:54,SEVEN:55,EIGHT:56,NINE:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90},input,app={},AppState={INIT:0,RUNNING:1};window.addEventListener("load",main);